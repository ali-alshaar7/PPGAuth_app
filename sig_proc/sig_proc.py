import pandas as pd
import random
import pickle

import openpyxl
import numpy as np
import matplotlib.pyplot as plt
from itertools import combinations, product


import torch
import torch.nn as nn
import torch.optim as optim
import torch.nn.functional as F
from torch.utils.data import Dataset, DataLoader
from sklearn.model_selection import train_test_split

from scipy.signal import find_peaks
from scipy.interpolate import splrep, splev
import numpy as np

def detrend(ppg_signal):
  # Create a time axis for the signal
    time_axis = np.arange(len(ppg_signal))

    # Fit a linear regression model to the signal
    coefficients = np.polyfit(time_axis, ppg_signal, 1)
    trend_line = np.polyval(coefficients, time_axis)

    # Detrend the signal by subtracting the trend line
    detrended_signal = ppg_signal - trend_line

    return detrended_signal, time_axis

def get_peaks(detrended_signal):
    min_sig = min(detrended_signal)
    max_sig = max(detrended_signal)
    thresh = abs(min_sig-max_sig)/200

    # Find peaks in the detrended signal
    peaks, _ = find_peaks([-sig for sig in detrended_signal], width=3, distance=25)

    return peaks

def averge_interp_cycle(detrended_signal, peaks):

    cycles = [detrended_signal[peaks[i]:peaks[i + 1]] for i in range(len(peaks) - 1)]
    # Number of points for the interpolated cycles
    num_interpolated_points = 50

    # Create a time array for the interpolated cycles
    interpolated_timestamps = np.linspace(0, 1, num_interpolated_points)

    # Interpolate each cycle using quadratic spline interpolation
    interpolated_cycles = []
    for cycle in cycles:
        tck = splrep(np.linspace(0, 1, len(cycle)), cycle, k=2)  # Quadratic spline interpolation (k=2)
        interpolated_cycle = splev(interpolated_timestamps, tck)
        interpolated_cycles.append(interpolated_cycle)

    return np.mean(interpolated_cycles, axis=0)

def sig_preproc(ppg_signal):
    detrended_signal, _ = detrend(ppg_signal)
    peaks = get_peaks(detrended_signal)
    return averge_interp_cycle(detrended_signal, peaks)

def load_data(file_path):
    # Load the workbook
    workbook = openpyxl.load_workbook(file_path)

    # Select the active sheet or specify the sheet name
    sheet = workbook.active
    # Or you can select a specific sheet by name: sheet = workbook['SheetName']

    data = {}

    # Iterate through rows
    for column in sheet.iter_cols(values_only=True):
        id = column[-1]
        if id is None:
            break
        id = int(column[-1])
        row_data = []
        for cell in column:
            if cell == None:
                break
            row_data.append(int(cell))
        if len(row_data) != 0:
            if id not in data:
                data[id] = []
            data[id].append(list(reversed(row_data)))

    # Close the workbook when done
    workbook.close()

    return data

def gen_cycles(data):
    cycle_data = {}
    for key in data:
        for sig in data[key]:
            if key not in cycle_data:
                cycle_data[key] = []
            cycle_data[key].append(sig_preproc(sig))
    return cycle_data

def gen_genuine_pairs(data):
    genuine = []
    for id in data:
        genuine_pairs = list(combinations(data[id], 2))
        genuine.extend(genuine_pairs)

    labels = [1] * len(genuine)

    return genuine, labels, len(genuine)

def gen_impostor_pairs(data, lenGen):
    impostors = []
    for id in data:
        for i in range(int(id)+1, len(data)+1):
            impostor_pairs = list(product(data[id], data[i]))
            impostors.extend(impostor_pairs)

    labels = [0] * len(impostors)

    return random.sample(impostors, lenGen), labels[0:lenGen]


def get_dataset(path, use_p=False):
    data = load_data(path)

    cycles = gen_cycles(data)
    if use_p:
        p = [-807.9201757318618, -850.0776699246278, -856.0190716648796, -825.7443809526168, -759.2535977878398, -656.5467221705487, -517.6237541007431, -359.48912216987856, -419.5869728715957, -766.1274138770974, -1401.4697521571215, -2325.686670132859, -2835.2907417985657, -1765.701202391994, 899.3436022930099, 5165.259903454919, 10672.975402293505, 14227.261286848165, 15074.98718224643, 13214.329116437804, 8643.473593182642, 3320.1385411237234, -417.99519546818055, -2566.276155139523, -3124.452955520599, -2325.3965131079226, -1566.335770474676, -1080.1425042255073, -866.9420593574683, -926.507483083535, -1085.1211557757863, -1197.2530070486252, -1262.9914079345347, -1282.0611960588144, -1263.7178298541799, -1247.9563252183284, -1239.234236211712, -1237.3387664720592, -1242.2125396831148, -1248.3416629440476, -1252.3856757766614, -1254.3477517490433, -1254.3867685826683, -1253.3633433501543, -1253.259388982193, -1254.2116990191037, -1256.2202734608857, -1259.2851123075395, -1263.4062155590643, -1268.5835832154614]
        p2 = [-254.96955445543608, -251.53978460879813, -247.56536896907784, -243.04630753627526, -237.98260031039047, -232.37424729142333, -226.22124847937397, -219.57538737755397, -213.22181627379746, -207.61325382645083, -202.83239988278652, -198.88072621581495, -195.27343884782698, -191.00510333995658, -185.57699935521208, -179.04511672032214, -171.519857927868, -163.8037646158669, -156.20273996923697, -148.9200229585567, -141.55209009239954, -133.11188587286, -123.02229340834764, -110.95551473817761, -96.5151617323219, -79.82801714627473, -61.66020748738593, -42.142467280399714, -22.609283326842046, -4.164133445523746, 11.305329251651695, 22.946195137407212, 31.372689907235326, 37.91119845709394, 44.0618055831251, 52.953498825124434, 64.69206840547474, 78.51704070455206, 99.06355541893704, 127.05476668858071, 161.7532730417215, 203.2144609078134, 252.88448442342332, 300.48908449590783, 346.62612007064695, 391.606065415394, 435.42892053014896, 478.09468541491174, 519.6033600696821, 559.9549444944605]
        p3 = [-129.6127677767654, -124.72228293711893, -120.26114863982181, -116.22936488487397, -112.6269316722755, -109.45384900202635, -106.71011687412653, -104.23162059232922, -101.54646238267485, -98.30672572365387, -94.34386062909246, -89.62791447558587, -84.5548453403743, -79.48766204573592, -74.8191776095245, -70.52111423072554, -66.41216860900627, -62.4420365647726, -58.42799051379242, -54.12644633659488, -49.662333757469625, -45.09153465826265, -40.44703268708928, -35.60058456084581, -30.337153974805837, -24.61767952372212, -18.305416734048215, -11.374764072324089, -3.794773302395683, 4.394474220766392, 12.89671035248943, 21.549842830474695, 30.104492867626156, 37.42549641561247, 43.003074725633766, 47.3701703722332, 50.58069539931091, 53.356531842324834, 58.22072656986438, 66.62737538798802, 82.44925006090418, 107.18290017419366, 138.458043851647, 173.12296461082184, 201.3210520110895, 217.6435053903876, 222.0903247487159, 214.6615100860744, 195.3570614024631, 164.17697869788208]
        p4 = [-114.44904033260536, -112.09185065595734, -109.47876467349629, -106.60978238522213, -103.48490379113495, -100.10412889123472, -96.46745768552144, -92.70663948269238, -89.03275978673797, -85.28396466546872, -81.35131236608902, -77.11574678283522, -72.5622138336273, -68.10353472048922, -63.839525022336495, -59.92329646856727, -56.50925119945952, -53.1760241112902, -49.786739911158044, -46.25268047202356, -42.333138836576616, -38.030586273127994, -33.55948154781435, -28.83483342385557, -23.70095546524007, -18.089081176755617, -11.645352233350946, -4.326010175618038, 3.602705122549863, 11.986351546921185, 20.053983166712577, 27.262635005569024, 33.51050076544184, 38.64265572610024, 42.557977495392564, 45.06983915701051, 46.307941082705455, 47.259449780819004, 48.290766934316494, 52.59120704108158, 65.43721826591728, 88.41964117920699, 119.51915454424802, 156.21097790121084, 183.0250048332804, 194.20962379733655, 189.76483479337915, 169.69063782140825, 133.9870328814238, 82.6540199734258]
        p5 = [-111.70271527153454, -109.09301099622519, -106.54477123973423, -104.05799600206166, -101.63268528320751, -99.26883908317176, -96.96645740195439, -94.55034247180616, -91.38293955742081, -87.4698618705807, -82.67676708030886, -77.18477331869919, -71.79347969675396, -67.1493895320489, -63.17266196817334, -59.94815149094914, -57.37574015181396, -55.3049260584249, -53.6629778516143, -52.22720211214128, -50.19678162026044, -46.8642094275626, -41.77170735479834, -34.969488708117, -27.072271122377444, -18.274905684113694, -9.137179301794555, 0.2512569966856948, 9.497437470611175, 18.25551586060799, 25.844473818105627, 31.514986606114114, 35.44710047236329, 38.2337623917109, 40.12929848489628, 41.0187153516086, 41.85997761990456, 44.55074806870377, 48.95558355648746, 59.93296868472937, 78.32467809799803, 103.04388701000153, 132.54561185529596, 162.62599503738184, 181.9044166256365, 190.43403530596987, 188.21485107838177, 175.2468639428723, 151.53007389944142, 117.06448094808911]
        p6 = [-33.83523552355473, -29.24460436332427, -25.183832944382534, -21.652921266729525, -18.651869330365255, -16.18067713528971, -14.2393446815029, -12.850673946207545, -11.86857970332978, -11.321107162796332, -11.084469597281236, -10.9883678624294, -10.762656232229928, -10.44588259534344, -9.648943683792355, -8.440822796966678, -7.115949776154547, -5.522944283954594, -3.8340067483105265, -2.447525857816619, -1.2992826964872737, -0.5423295777129015, -0.18505367364067973, 0.11904569832136147, 0.6755136478368294, 1.5215746005610538, 3.001280091204175, 5.231440536784015, 8.022311663476275, 10.945087335993612, 14.034100253875186, 16.995939073033643, 18.650468431158448, 19.512275824012555, 19.827216172637755, 19.22220353381883, 18.778992866178466, 19.630787020830216, 22.880039732551797, 30.32628683959474, 41.910746439090005, 57.390085928085306, 75.55051730029415, 90.45860719913826, 96.51455168550395, 93.40435604519583, 81.12802027821385, 59.68554438455797, 29.076928364228234, -10.697827782775372]
        p7 = [-60.84654815484646, -58.44483007829817, -56.20866608439422, -54.13805617313459, -52.23300034451931, -50.42299689752609, -48.61132449025661, -46.80622989947252, -45.18242794350653, -43.48341856847216, -41.754902207502724, -39.74433311873494, -37.38823688952136, -34.99629027439034, -33.2852014171799, -31.896315720456307, -30.503965459571802, -28.809690045385768, -26.60149334541895, -23.835139540726406, -20.677998535082004, -17.19711648027002, -13.411903474315876, -9.383111837058866, -4.676889023188442, 1.1958587504143219, 7.7810390806269965, 14.774177305318302, 21.65294328684104, 27.622547624633725, 27.94227263657981, 21.665771026240886, 11.699836084378422, 6.6745453369049015, 7.3783041429064165, 11.099229076547518, 14.938209907397656, 20.075512675351767, 27.497256030362546, 37.558912730782126, 50.05640588152585, 63.35840244185145, 74.54976135731931, 81.07149523915902, 83.68246809021204, 82.42003598495494, 77.14186531879528, 67.74420689802407, 54.22706072264136, 36.59042679264712]
        p8 = [-70.23757575759373, -67.50295044386363, -64.76651712336549, -62.02827579609931, -59.28822646206514, -56.54636912126292, -53.99148682638588, -51.99050399860698, -50.28163087457621, -48.86683660849538, -47.420466186902765, -45.74122147782601, -43.940770034398454, -42.38176469723488, -41.348448184958734, -40.54408777599645, -39.73112613017122, -38.20300263760839, -35.765677500011705, -32.48341990849495, -28.716209828365926, -24.99996828062536, -21.71793725528639, -18.840234591175484, -16.28504280703321, -13.93990603266034, -11.043054516416907, -7.573510769075265, -3.74407117709587, 0.44545723257313846, 4.663850944069003, 9.513373806484195, 14.71049359230698, 20.110421483867658, 24.80527409865491, 26.700815014058662, 26.44332699396899, 25.22696821015049, 24.35973584588476, 25.247301479148042, 30.11939350305325, 39.97183294075926, 54.17053799478905, 70.71601925192974, 81.72381428762831, 84.05708870408863, 77.59038498760493, 62.32370313817728, 38.25704315580564, 5.390405040490025]
        p9 = [-369.82693744373864, -364.4270754638611, -359.0456284495121, -353.68259640069147, -348.33797931739946, -343.0117771996358, -337.7039900474008, -332.4285792160398, -327.4196409744809, -322.5464010439807, -317.24283755493894, -311.5206624758347, -305.2708323305562, -298.12661323315797, -289.69158719802084, -280.5164452753708, -270.70736884515406, -260.08780031428364, -249.07620423740713, -238.4469917380431, -227.7264937478613, -216.50678518038347, -204.93289609247677, -191.01590497545786, -172.78781585540403, -150.17646626559895, -122.77511846964308, -90.520737648564, -55.6525268773764, -21.109424776628416, 11.992064173132924, 41.19299761617576, 65.07005674793308, 82.76047576187557, 93.95396219100483, 100.27647071138385, 103.49587907445725, 109.34647691138376, 129.06186319011314, 167.257629540187, 224.09621178720906, 300.19727683202314, 394.0436007124873, 482.8600016966982, 563.3197080908524, 635.6813250935606, 699.9448527048227, 756.1102909246384, 804.177639753008, 844.146899189931]
        p10 = [-329.42753750376687, -324.7447806179162, -319.7707624972023, -314.50548314162495, -308.94894255118436, -303.1011407258804, -296.9620776657131, -290.5346926248261, -283.78900995713514, -276.56087766113035, -268.9687962073023, -261.0400389818142, -252.85207633152623, -244.65901057653656, -236.74146064065675, -228.80708132646328, -220.70520022806073, -211.95187334798246, -202.22404489499485, -191.13376331845822, -178.6590088991668, -164.84893563735898, -149.69727714499942, -132.32797050690974, -112.1235998318122, -89.08230946818031, -63.20070147373022, -34.48302192696714, -5.193702027716613, 21.706683200901576, 44.663462781821444, 62.79342572861081, 76.29934151945888, 87.3204682672035, 97.08935545084125, 106.44421890688301, 116.45842243683516, 130.36295192282176, 156.82380597922085, 207.04507478540077, 285.7682483509453, 393.51851283618294, 523.8985554547513, 638.7428969782273, 712.2606053666605, 743.2542308872003, 731.7237735398458, 677.6692333245971, 581.0906102414544, 441.98790429041765]
        id = len(data)
        data[id + 1] = [p, p2, p3, p4, p5, p6, p7, p8, p9, p10]

    data = []
    labels = []

    data, labels, lenGen = gen_genuine_pairs(cycles)
    impostor_data, i_labels = gen_impostor_pairs(cycles, lenGen)
    data.extend(impostor_data)
    labels.extend(i_labels)

    
    combined_lists = list(zip(data, labels))
    random.shuffle(combined_lists)
    data, labels = zip(*combined_lists)

    return list(data), list(labels)

def get_full_dataset():
    train_path = 'yynb8t9x3d-2/train8.xlsx'
    test_path = 'yynb8t9x3d-2/test8.xlsx'
    data = []
    labels = []

    data, labels = get_dataset(train_path, True)
    test_data, test_labels = get_dataset(test_path)
    data.extend(test_data)
    labels.extend(test_labels)

    return data, labels

def pickle_dataset():
    data, labels = get_full_dataset()
    combined_dict = {'data': data, 'labels': labels}

    # Pickle the combined data and save to a file
    with open('yynb8t9x3d-2/dataset.pkl', 'wb') as file:
        pickle.dump(combined_dict, file)

def unpickle_dataset():

    # Load the pickled data from the file
    with open('yynb8t9x3d-2/dataset.pkl', 'rb') as file:
        loaded_data = pickle.load(file)

    # Access the lists from the loaded data
    data = loaded_data['data']
    labels = loaded_data['labels']

    return data, labels


pickle_dataset()

#pickle_dataset()
data, labels = unpickle_dataset()
X_train, X_test, y_train, y_test = train_test_split(data, labels, test_size=0.2, random_state=42)

# Convert data to PyTorch tensors
X_train = torch.Tensor(X_train).cuda()
X_test = torch.Tensor(X_test).cuda()
y_train = torch.Tensor(y_train).cuda()
y_test = torch.Tensor(y_test).cuda()

# Define Siamese CNN architecture
class SiameseCNN(nn.Module):
    def __init__(self):
        super(SiameseCNN, self).__init__()
        self.cnn = nn.Sequential(
            nn.Conv1d(1, 16, kernel_size=3),
            nn.ReLU(inplace=True),
            nn.MaxPool1d(kernel_size=2),
            nn.BatchNorm1d(16),
            
            nn.Conv1d(16, 32, kernel_size=3),
            nn.ReLU(inplace=True),
            nn.MaxPool1d(kernel_size=2),
            nn.BatchNorm1d(32),
            
            nn.Conv1d(32, 64, kernel_size=3),
            nn.ReLU(inplace=True),
            nn.MaxPool1d(kernel_size=2),
            nn.BatchNorm1d(64),

            nn.Flatten()
        )
        self.fc = nn.Sequential(
            nn.Linear(256, 64),
            nn.ReLU(inplace=True),

            nn.Linear(64, 16),
            nn.ReLU(inplace=True),

            nn.Linear(16, 1),
            nn.Sigmoid(),

        )

    def forward_one(self, x):
        return self.cnn(x)

    def forward(self, input1, input2):
        output1 = self.forward_one(input1)
        output2 = self.forward_one(input2)

        subtracted_output = output1 - output2
        output = self.fc(subtracted_output)
        return output


# Instantiate the Siamese CNN model, loss function, and optimizer
model = SiameseCNN().cuda()
criterion = nn.BCELoss().cuda()
optimizer = optim.Adam(model.parameters(), lr=0.0001)

# Convert labels to LongTensor for binary classification
y_train = y_train.type(torch.LongTensor).cuda()
y_test = y_test.type(torch.LongTensor).cuda()

# Create DataLoader for batch training
batch_size = 32
train_dataset = torch.utils.data.TensorDataset(X_train, y_train)
train_loader = torch.utils.data.DataLoader(dataset=train_dataset, batch_size=batch_size, shuffle=True)

print(next(model.parameters()).is_cuda)

# Training loop with batch training
num_epochs = 100
for epoch in range(num_epochs):
    model.train()
    for inputs, labels in train_loader:
        optimizer.zero_grad()
        output = model(inputs[:, 0, :].unsqueeze(1), inputs[:, 1, :].unsqueeze(1))
        loss = criterion(output.squeeze(), labels.float())
        loss.backward()
        optimizer.step()
    print(f'Epoch [{epoch + 1}/{num_epochs}], Loss: {loss.item():.4f}')
    torch.save(model.state_dict(), 'yynb8t9x3d-2/model_params.pt')

# Evaluate on the test set
model.eval()
with torch.no_grad():
    correct = 0
    total = 0
    for i in range(len(X_test)):
        input1, input2, label = X_test[i][0], X_test[i][1], y_test[i]
        output = model(input1.unsqueeze(0).unsqueeze(0), input2.unsqueeze(0).unsqueeze(0))
        prediction = 1 if output > 0.5 else 0  # Adjust threshold as needed
        total += 1
        correct += (prediction == label.item())

accuracy = correct / total
print(f'Test Accuracy: {accuracy * 100:.2f}%')


